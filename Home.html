
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
<link rel="icon" href="favicon.ico" type="image/ico">

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
  /* --- Ø³ØªØ§ÙŠÙ„ Ù…ÙØ®ØªØµØ± ÙˆÙ…Ø±ÙŠØ­ --- */
  body{font-family:"Cairo",sans-serif;margin:0;background:#f3f4f6;color:#333;direction:rtl;transition:.25s}
  body.dark{background:#111827;color:#e5e7eb}
  header{background:linear-gradient(135deg,#4f46e5,#26cedc);color:#fff;padding:20px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .link-btn a{display:inline-block;background:linear-gradient(135deg,#4f46e5,#6366f1);color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none}
  .toggle-btn{background:#fff;color:#4f46e5;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
  body.dark .toggle-btn{background:#1f2937;color:#f3f4f6}
  main{max-width:900px;margin:28px auto;padding:0 16px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px}
  input[type="text"],select,button{padding:10px 12px;border-radius:8px;border:1px solid #ddd;font-size:14px}
  input[type="text"]{flex:1}
  button.primary{background:#4f46e5;color:#fff;border:0;cursor:pointer}
  button.danger{background:#dc2626;color:#fff;border:0;cursor:pointer}
  .subject-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
  body.dark .subject-card{background:#1f2937;color:#f9fafb}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .file-label{display:inline-block;padding:8px 12px;background:#6366f1;color:#fff;border-radius:8px;cursor:pointer}
  .preview-container{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .preview-container img{width:100px;height:100px;object-fit:cover;border-radius:8px;cursor:move}
  .progress-bar{height:8px;width:0;background:#4f46e5;border-radius:6px;transition:width .25s}
  footer{text-align:center;padding:18px;color:#0e7653;margin-top:30px}
  @media(max-width:600px){.controls{flex-direction:column}input[type="text"],select,button{width:100%}}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <span style="font-weight:700;font-size:18px">ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</span>
  </div>

  <div style="display:flex;align-items:center;gap:10px">
    <div class="link-btn"><a href="https://ah9742824-oss.github.io/my-project/" target="_blank" title="Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">ğŸŒ</a></div>
    <button class="toggle-btn" id="toggleDark">ğŸŒ™/â˜€ï¸</button>
  </div>
</header>

<main>
  <div class="controls">
    <input type="text" id="subjectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©..." aria-label="subject name">
    <select id="qualitySelect" title="Ø§Ø®ØªÙŠØ§Ø± Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±">
      <option value="1.0">ğŸ” Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</option>
      <option value="0.8">âœ¨ Ø¬ÙˆØ¯Ø© Ù…ØªÙˆØ³Ø·Ø©</option>
      <option value="0.6">ğŸ“„ Ø¬ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø© (Ø­Ø¬Ù… ØµØºÙŠØ±)</option>
    </select>
    <button id="addBtn" class="primary">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div id="subjects"></div>
</main>

<footer>
  Designed & Developed by: Ahmed Hany Sayed Ahmed Abdel Wahab &copy; 2025
</footer>

<script>
/* ======= Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ======= */
const subjectsKey = "my_library_subjects_v2";
let subjects = []; // ÙƒÙ„ Ø¹Ù†ØµØ±: { id, name, images:[{id,file,url}], pdf: blobUrl|null }

/* ======= Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ======= */
function loadSubjects(){
  try{
    const raw = localStorage.getItem(subjectsKey);
    if(raw) subjects = JSON.parse(raw);
    else subjects = [];
  }catch(e){ console.warn("loadSubjects error",e); subjects=[];}
}
function saveSubjects(){
  // Ù†Ø­ØªÙØ¸ ÙÙ‚Ø· Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙÙŠ localStorage (Ù„Ø§ Ù†Ø®Ø²Ù† File Ø£Ùˆ blob URLs Ø·ÙˆÙŠÙ„Ø©)
  // Ù„ÙƒÙ† Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø®Ø²Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØµÙˆØ± ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù€ blob URLs Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©.
  try{
    const copy = subjects.map(s=>({
      id:s.id,
      name:s.name,
      // images we keep only id and url (url may be blob:), but File objects are not serializable
      images: s.images ? s.images.map(im => ({ id: im.id, url: im.url })) : [],
      pdf: s.pdf || null
    }));
    localStorage.setItem(subjectsKey, JSON.stringify(copy));
  }catch(e){ console.warn("saveSubjects",e); }
}

/* ======= Toaster ======= */
function toast(msg, type="info"){
  if(window.Toastify){
    Toastify({text:msg,duration:2500,gravity:"top",position:"center",backgroundColor:type==="error"?"#dc2626":"#4f46e5"}).showToast();
  } else {
    alert(msg);
  }
}

/* ======= DOM Ø¹Ù†Ø§ØµØ± ======= */
const subjectsContainer = document.getElementById("subjects");
const addBtn = document.getElementById("addBtn");
const subjectNameInput = document.getElementById("subjectName");
const qualitySelect = document.getElementById("qualitySelect");
const toggleDark = document.getElementById("toggleDark");

/* ======= Dark Mode Ù…Ø­ÙÙˆØ¸ ======= */
if(localStorage.getItem("darkMode")==="true"){ document.body.classList.add("dark"); }
toggleDark.addEventListener("click", ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
});

/* ======= Ø¥Ù†Ø´Ø§Ø¡ ID ÙØ±ÙŠØ¯ Ø¨Ø³ÙŠØ· ======= */
function uid(prefix="id"){ return prefix + "_" + Date.now().toString(36) + "_" + Math.floor(Math.random()*10000).toString(36); }

/* ======= Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ======= */
function addSubjectFromInput(){
  const name = subjectNameInput.value.trim();
  if(name){
    addSubject(name);
    subjectNameInput.value = "";
    subjectNameInput.focus();
  } else {
    // Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø¶ÙŠØŒ Ù†Ø·Ù„Ø¨ Ø§Ø³Ù… Ø¹Ø¨Ø± prompt (ØªØ¬Ø±Ø¨Ø© Ø¨Ø¯ÙŠÙ„Ø©)
    const p = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:");
    if(p && p.trim()) addSubject(p.trim());
  }
}
function addSubject(name){
  const s = { id: uid("subj"), name, images: [], pdf: null };
  subjects.push(s);
  saveSubjects();
  renderSubjects();
  toast("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©");
}

/* Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙØ© -- ØªØ£ÙƒØ¯Ù†Ø§ Ø¥Ù†Ù‡ ÙŠØ´ØªØºÙ„ Ø¹Ø¨Ø± addEventListener */
addBtn.addEventListener("click", addSubjectFromInput);

/* Ø¯Ø¹Ù… Ø§Ù„Ø¶ØºØ· Enter Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… */
subjectNameInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") addSubjectFromInput();
});

/* ======= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ======= */
loadSubjects();

/* ======= Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ======= */
function renderSubjects(){
  subjectsContainer.innerHTML = "";
  subjects.forEach((subj, idx) => {
    const card = document.createElement("div");
    card.className = "subject-card";
    card.dataset.index = idx;
    card.innerHTML = `
      <h3>${escapeHtml(subj.name)}</h3>
      <label class="file-label" for="fileInput-${subj.id}">ğŸ“‚ Ø§Ø®ØªØ± ØµÙˆØ±</label>
      <input type="file" id="fileInput-${subj.id}" style="display:none" multiple accept="image/*">
      <p id="fileCount-${subj.id}" style="margin:8px 0;color:#666;font-size:14px;">${(subj.images && subj.images.length) ? "ğŸ–¼ï¸ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±: " + subj.images.length : "ğŸ–¼ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¨Ø¹Ø¯"}</p>
      <div class="preview-container" id="preview-${subj.id}"></div>
      <p id="progress-${subj.id}" style="margin:8px 0;color:#555;font-size:14px;"></p>
      <div class="progress-bar" id="bar-${subj.id}" style="margin-top:6px"></div>
      <div class="actions">
        <button class="primary" data-action="convert" data-idx="${idx}">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« PDF</button>
        <button data-action="preview" data-idx="${idx}" ${!subj.pdf ? "disabled" : ""}>ğŸ‘€ Ù…Ø¹Ø§ÙŠÙ†Ø© PDF</button>
        <button data-action="download" data-idx="${idx}" ${!subj.pdf ? "disabled" : ""}>â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PDF</button>
        <button data-action="edit" data-idx="${idx}">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù…</button>
        <button data-action="delete" data-idx="${idx}" class="danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    `;
    subjectsContainer.appendChild(card);

    // Ø±Ø¨Ø· input Ø§Ù„Ù…Ù„ÙØ§Øª
    const fileInput = card.querySelector(`#fileInput-${subj.id}`);
    const preview = card.querySelector(`#preview-${subj.id}`);
    const fileCount = card.querySelector(`#fileCount-${subj.id}`);

    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø®Ø²Ù†Ø© ÙƒÙ€ urls ÙÙ‚Ø·)
    preview.innerHTML = "";
    subj.images = subj.images || [];
    subj.images.forEach(im=>{
      const imgEl = document.createElement("img");
      imgEl.src = im.url;
      imgEl.dataset.id = im.id;
      preview.appendChild(imgEl);
    });

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù€ Sortable
    new Sortable(preview, {
      animation: 150,
      ghostClass: "dragging",
      onEnd: function(){
        const ids = Array.from(preview.children).map(el => el.dataset.id);
        subj.images = ids.map(id => subj.images.find(im => String(im.id) === String(id))).filter(Boolean);
        saveSubjects();
      }
    });

    // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©
    fileInput.addEventListener("change", (e)=>{
      const files = Array.from(e.target.files || []);
      subj.images = files.map(f => ({ id: uid("img"), file: f, url: URL.createObjectURL(f) }));
      fileCount.textContent = subj.images.length ? `ğŸ–¼ï¸ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±: ${subj.images.length}` : "ğŸ–¼ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¨Ø¹Ø¯";
      preview.innerHTML = "";
      subj.images.forEach(im=>{
        const imgEl = document.createElement("img");
        imgEl.src = im.url;
        imgEl.dataset.id = im.id;
        preview.appendChild(imgEl);
      });
      saveSubjects();
    });
  });
}

/* ======= ØªÙØ§Ø¯ÙŠ XSS Ø¨Ø³ÙŠØ· ======= */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ======= ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (ØªÙÙˆÙŠØ¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«) ======= */
subjectsContainer.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const action = btn.dataset.action;
  const idx = parseInt(btn.dataset.idx);
  if(isNaN(idx)) return;

  if(action === "delete"){
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")){
      subjects.splice(idx,1);
      saveSubjects();
      renderSubjects();
      toast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
    }
  } else if(action === "edit"){
    const newName = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", subjects[idx].name);
    if(newName && newName.trim()){
      subjects[idx].name = newName.trim();
      saveSubjects();
      renderSubjects();
      toast("âœï¸ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…");
    }
  } else if(action === "preview"){
    const s = subjects[idx];
    if(s && s.pdf) window.open(s.pdf,"_blank");
  } else if(action === "download"){
    const s = subjects[idx];
    if(s && s.pdf){
      const a = document.createElement("a");
      a.href = s.pdf; a.download = `${s.name || "document"}.pdf`;
      a.click();
    }
  } else if(action === "convert"){
    convertToPDF(idx);
  }
});

/* ======= ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ PDF (Ø¨Ø¬ÙˆØ¯Ø© Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) ======= */
async function convertToPDF(index){
  const subj = subjects[index];
  if(!subj) return;
  if(!subj.images || subj.images.length === 0){
    toast("ğŸ“Œ Ø§Ø®ØªØ± ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹", "error");
    return;
  }
  const quality = parseFloat(qualitySelect.value || "1.0");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const progressEl = document.getElementById(`progress-${subj.id}`);
  const barEl = document.getElementById(`bar-${subj.id}`);
  barEl.style.width = "0%";
  progressEl.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...";

  for(let j=0;j<subj.images.length;j++){
    await new Promise((resolve)=>{
      const im = subj.images[j];
      // Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙ†Ø§ Ù…Ù„Ù (Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¯ÙŠØ«Ø§Ù‹) Ù†Ù‚Ø±Ø£Ù‡ Ù…Ù† object URL
      const image = new Image();
      image.onload = ()=>{
        // Ø­Ø³Ø§Ø¨ Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ØµÙØ­Ø© A4
        const maxW = 210, maxH = 297;
        const ratio = Math.min(maxW / image.width, maxH / image.height);
        const w = image.width * ratio;
        const h = image.height * ratio;

        // Ù†Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù†ÙØ§Ø³ Ø¨Ø¯Ù‚Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø£ÙØ¶Ù„
        const canvas = document.createElement("canvas");
        canvas.width = image.width;
        canvas.height = image.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(image, 0, 0, image.width, image.height);

        const dataURL = canvas.toDataURL("image/jpeg", quality);

        if(j>0) pdf.addPage();
        pdf.addImage(dataURL, "JPEG", (210 - w)/2, (297 - h)/2, w, h);

        barEl.style.width = Math.round(((j+1)/subj.images.length)*100) + "%";
        progressEl.textContent = `ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„... ${Math.round(((j+1)/subj.images.length)*100)}%`;
        resolve();
      };
      // image.src ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† blob URL Ø£Ùˆ Ø£ÙŠ url Ù…Ø­ÙÙˆØ¸
      image.onerror = ()=>{ resolve(); };
      image.src = im.url;
    });
  }

  const blob = pdf.output("blob");
  // ØªÙ†Ø¸ÙŠÙ blob URL Ø³Ø§Ø¨Ù‚ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
  if(subj.pdf) URL.revokeObjectURL(subj.pdf);
  subj.pdf = URL.createObjectURL(blob);
  saveSubjects();
  renderSubjects();
  barEl.style.width = "100%";
  progressEl.textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF";
  toast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ø¬ÙˆØ¯Ø© " + (quality===1? "Ø¹Ø§Ù„ÙŠØ©" : quality===0.8? "Ù…ØªÙˆØ³Ø·Ø©" : "Ù…Ù†Ø®ÙØ¶Ø©"));
}

/* ======= Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù†Ø±Ø³Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======= */
renderSubjects();

</script>
</body>
</html>

